<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GitHub â†’ Wikidata QuickStatements</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            padding: 20px;
        }
        button {
            margin-right: 10px;
        }
        #status {
            margin-top: 15px;
            white-space: pre-line;
        }
    </style>
</head>
<body>

    <h1>GitHub Start Time Fetcher</h1>

    <button id="startRequests">Fetch GitHub Data</button>
    <button id="downloadCsv" disabled>Download CSV</button>

    <div id="status">Idle.</div>

    <script>
        const STATUS = document.getElementById("status");
        const startButton = document.getElementById("startRequests");
        const downloadButton = document.getElementById("downloadCsv");

        const DISPLAY_LIMIT = 50;

        let csvRows = [];
        let successCount = 0;
        let totalCount = 0;

        function qidFromUri(uri) {
            return uri.split("/").pop();
        }

        async function fetchGitHubCreatedAt(username) {
            const response = await fetch(`https://api.github.com/users/${username}`);
            if (!response.ok) {
                throw new Error("GitHub request failed");
            }
            const data = await response.json();
            return data.created_at.split("T")[0]; // YYYY-MM-DD only
        }

        startButton.addEventListener("click", async () => {
            STATUS.textContent = "Loading query.json...";
            startButton.disabled = true;

            csvRows = [];
            successCount = 0;

            try {
                const response = await fetch("query.json");
                const items = await response.json();

                const limitedItems = items.slice(0, DISPLAY_LIMIT);
                totalCount = limitedItems.length;

                STATUS.textContent =
                    `Loaded ${items.length} items.\n` +
                    `Processing first ${totalCount} only...\n`;

                // CSV header
                csvRows.push("qid,P2037,P580");

                for (let i = 0; i < limitedItems.length; i++) {
                    const { item, githubHandle } = limitedItems[i];
                    const qid = qidFromUri(item);

                    try {
                        const date = await fetchGitHubCreatedAt(githubHandle);

                        csvRows.push(
                            `${qid},${githubHandle},${date}`
                        );

                        successCount++;
                    } catch (e) {
                        // Failure intentionally ignored
                    }

                    STATUS.textContent =
                        `Processed ${i + 1}/${totalCount}\n` +
                        `Successful requests: ${successCount}`;
                }

                STATUS.textContent += "\nDone.";
                downloadButton.disabled = false;

            } catch (err) {
                STATUS.textContent = "Fatal error: " + err.message;
            }
        });

        downloadButton.addEventListener("click", () => {
            const blob = new Blob([csvRows.join("\n")], {
                type: "text/csv;charset=utf-8;"
            });

            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");

            link.href = url;
            link.download = "github_start_times_quickstatements.csv";
            document.body.appendChild(link);
            link.click();

            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        });
    </script>

</body>
</html>
